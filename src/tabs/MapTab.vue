<script>
  /**
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   * ğŸ—ºï¸ MapTab.vue - D3.js è·‘é“åœ°åœ–çµ„ä»¶
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   *
   * @fileoverview
   * é€™æ˜¯ä¸€å€‹åŸºæ–¼ D3.js çš„åœ°åœ–è¦–è¦ºåŒ–çµ„ä»¶ï¼Œé¡¯ç¤ºè·‘é“ç·šè·¯æ•¸æ“šã€‚
   * æœ¬çµ„ä»¶è² è²¬è¼‰å…¥ã€è™•ç†å’Œæ¸²æŸ“è·‘é“ GeoJSON æ•¸æ“šã€‚
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 1. è·‘é“ç·šè·¯æ¸²æŸ“ï¼š
   *    âœ“ è¼‰å…¥ runway.geojson
   *    âœ“ ç¹ªè£½æ‰€æœ‰è·‘é“ç·šè·¯
   *
   * 2. è¦–è¦ºå…ƒç´ ï¼š
   *    âœ“ è·‘é“ç·šè·¯ï¼šç·šæ¢ç¹ªè£½
   *    âœ“ ç™½è‰²åœ°åœ–èƒŒæ™¯
   *
   * 3. äº¤äº’åŠŸèƒ½ï¼š
   *    âœ“ æ»¾è¼ªç¸®æ”¾æ§åˆ¶
   *    âœ“ æ‹–å‹•å¹³ç§»å°èˆª
   *    âœ“ æ»‘é¼ æ‡¸åœé¡¯ç¤ºè³‡è¨Š
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ¨ é…è‰²ä¸»é¡Œ
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ç™½è‰²      #ffffff  â†’ åœ°åœ–èƒŒæ™¯
   * è·‘é“ç·šè·¯  #333333  â†’ æ·±ç°è‰²ç·šæ¢
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ› ï¸ æŠ€è¡“æ£§
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @requires vue                 - Vue 3.2+ (Composition API)
   * @requires d3                  - D3.js 7.8+ (åœ°åœ–ç¹ªè£½åº«)
   * @requires @/stores/dataStore  - Pinia ç‹€æ…‹ç®¡ç†
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ æ•¸æ“šä¾†æº
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * è·‘é“ç·šè·¯ï¼šrunway.geojson
   * è·¯å¾‘ï¼špublic/data/geojson/
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ”§ ä½¿ç”¨æ–¹å¼
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * <MapTab @map-ready="handleMapReady" />
   *
   * @event map-ready - åœ°åœ–åˆå§‹åŒ–å®Œæˆæ™‚è§¸ç™¼ï¼Œè¿”å›åœ°åœ–å¯¦ä¾‹
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ ç¶­è­·è€…
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @author Kevin Cheng
   * @version 5.0.0
   * @since 2024
   * @license MIT
   *
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   */

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ ä¾è³´å°å…¥ (Dependencies Import)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Vue 3 æ ¸å¿ƒåŠŸèƒ½
  import { ref, onMounted, onUnmounted, nextTick } from 'vue';

  // D3.js åœ°åœ–åº«
  import * as d3 from 'd3';

  // Pinia ç‹€æ…‹ç®¡ç†
  import { useDataStore } from '@/stores/dataStore';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ¯ çµ„ä»¶å®šç¾© (Component Definition)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  export default {
    name: 'MapTab',

    // çµ„ä»¶è§¸ç™¼çš„äº‹ä»¶
    emits: [
      'map-ready', // åœ°åœ–åˆå§‹åŒ–å®Œæˆæ™‚è§¸ç™¼ï¼Œå‚³éåœ°åœ–å¯¦ä¾‹
    ],

    /**
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ğŸ¬ çµ„ä»¶è¨­ç½®å‡½æ•¸ (Component Setup Function)
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ä½¿ç”¨ Vue 3 Composition API è¨­ç½®çµ„ä»¶é‚è¼¯
     *
     * @param {Object} _ - Propsï¼ˆæœ¬çµ„ä»¶ä¸ä½¿ç”¨ï¼‰
     * @param {Object} context - è¨­ç½®ä¸Šä¸‹æ–‡
     * @param {Function} context.emit - äº‹ä»¶è§¸ç™¼å‡½æ•¸
     * @returns {Object} è¿”å›æ¨¡æ¿å¯ç”¨çš„éŸ¿æ‡‰å¼æ•¸æ“šå’Œæ–¹æ³•
     */
    setup(_, { emit }) {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¦ ç‹€æ…‹ç®¡ç†èˆ‡ä¾è³´ (State Management & Dependencies)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // Pinia æ•¸æ“šå­˜å„²ï¼ˆä¿ç•™ä¾›æœªä¾†æ“´å±•ä½¿ç”¨ï¼‰
      // eslint-disable-next-line no-unused-vars
      const dataStore = useDataStore();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ—ºï¸ åœ°åœ–ç›¸é—œè®Šæ•¸ (Map-Related Variables)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * åœ°åœ– DOM å®¹å™¨å¼•ç”¨
       * @type {Ref<HTMLElement|null>}
       */
      const mapContainer = ref(null);

      /**
       * D3.js SVG å…ƒç´ 
       * @type {d3.Selection|null}
       */
      let svg = null;

      /**
       * D3.js æŠ•å½±å‡½æ•¸
       * @type {d3.GeoProjection|null}
       */
      let projection = null;

      /**
       * D3.js è·¯å¾‘ç”Ÿæˆå™¨
       * @type {d3.GeoPath|null}
       */
      let path = null;

      /**
       * D3.js ç¸®æ”¾è¡Œç‚º
       * @type {d3.ZoomBehavior|null}
       */
      let zoom = null;

      /**
       * SVG ä¸»å®¹å™¨çµ„
       * @type {d3.Selection|null}
       */
      let g = null;

      /**
       * å·¥å…·æç¤ºå…ƒç´ 
       * @type {HTMLElement|null}
       */
      let tooltip = null;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ›ï¸ æ§åˆ¶ç‹€æ…‹ (Control States)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * åœ°åœ–å°±ç·’ç‹€æ…‹æ¨™è¨˜
       * true = åœ°åœ–å·²åˆå§‹åŒ–å®Œæˆï¼Œfalse = å°šæœªåˆå§‹åŒ–
       * @type {Ref<boolean>}
       */
      const isMapReady = ref(false);

      /**
       * åœ°åœ–å®¹å™¨å”¯ä¸€ ID
       * ä½¿ç”¨éš¨æ©Ÿå­—ç¬¦ä¸²ç¢ºä¿å¤šå¯¦ä¾‹æ™‚ä¸æœƒè¡çª
       * @type {Ref<string>}
       */
      const mapContainerId = ref(`leaflet-map-${Math.random().toString(36).substr(2, 9)}`);

      /**
       * é¡¯ç¤ºæ¨¡å¼
       * 'map' = ä½¿ç”¨åœ°åœ–æŠ•å½±é¡¯ç¤ºï¼ˆç›®å‰çµæœï¼‰
       * 'grid' = ç›´æ¥ä½¿ç”¨ grid_x, grid_y ç¹ªè£½ç¶²æ ¼
       * @type {Ref<string>}
       */
      const displayMode = ref('map');

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“Š GeoJSON æ•¸æ“šå„²å­˜ (GeoJSON Data Storage)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * è·‘é“ GeoJSON æ•¸æ“š
       * ä¾†æºï¼šrunway.geojson
       * @type {Ref<Object|null>}
       */
      const runwayData = ref(null);

      /**
       * ğŸ”§ å»¶ä¼¸ç·šæ®µ 5 å€é•·åº¦
       * @param {Array} coordinates - LineString åº§æ¨™é™£åˆ—
       * @returns {Array} å»¶ä¼¸å¾Œçš„åº§æ¨™é™£åˆ—
       */
      const extendLineString = (coordinates) => {
        if (!coordinates || coordinates.length < 2) {
          return coordinates;
        }

        // å–ç¬¬ä¸€å€‹é»å’Œæœ€å¾Œä¸€å€‹é»
        const startPoint = coordinates[0];
        const endPoint = coordinates[coordinates.length - 1];

        // è¨ˆç®—æ–¹å‘å‘é‡ï¼ˆç¶“åº¦å·®å’Œç·¯åº¦å·®ï¼‰
        const dx = endPoint[0] - startPoint[0];
        const dy = endPoint[1] - startPoint[1];

        // è¨ˆç®—åŸç·šæ®µé•·åº¦ï¼ˆä½¿ç”¨æ­å¹¾é‡Œå¾—è·é›¢ï¼‰
        const length = Math.sqrt(dx * dx + dy * dy);

        if (length === 0) {
          return coordinates; // å¦‚æœç·šæ®µé•·åº¦ç‚º0ï¼Œç›´æ¥è¿”å›
        }

        // æ­£è¦åŒ–æ–¹å‘å‘é‡
        const unitDx = dx / length;
        const unitDy = dy / length;

        // å»¶ä¼¸å€æ•¸
        const extendFactor = 5;

        // è¨ˆç®—å»¶ä¼¸è·é›¢ï¼ˆåŸé•·åº¦çš„5å€ï¼‰
        const extendDistance = length * extendFactor;

        // å¾èµ·é»æ²¿åæ–¹å‘å»¶ä¼¸
        const newStartPoint = [
          startPoint[0] - unitDx * extendDistance,
          startPoint[1] - unitDy * extendDistance,
        ];

        // å¾çµ‚é»æ²¿æ­£æ–¹å‘å»¶ä¼¸
        const newEndPoint = [
          endPoint[0] + unitDx * extendDistance,
          endPoint[1] + unitDy * extendDistance,
        ];

        // è¿”å›å»¶ä¼¸å¾Œçš„åº§æ¨™é™£åˆ—
        return [newStartPoint, newEndPoint];
      };

      /**
       * ğŸ“¥ è¼‰å…¥è·‘é“ç·šè·¯ GeoJSON æ•¸æ“š
       */
      const loadRunwayData = async () => {
        try {
          console.log('[MapTab] é–‹å§‹è¼‰å…¥è·‘é“ç·šè·¯ GeoJSON æ•¸æ“š...');

          // è¼‰å…¥è·‘é“ GeoJSON æª”æ¡ˆ
          const runwayResponse = await fetch(
            `${process.env.BASE_URL}data/geojson/runway.geojson`
          );

          // æª¢æŸ¥éŸ¿æ‡‰
          if (!runwayResponse.ok) {
            throw new Error(`è·‘é“ç·šè·¯æ•¸æ“šè¼‰å…¥å¤±æ•—: HTTP ${runwayResponse.status}`);
          }

          // è§£æ JSON
          const rawData = await runwayResponse.json();

          // å»¶ä¼¸æ¯æ¢ç·šæ®µ 5 å€ï¼Œä¸¦ä¿å­˜åŸå§‹åº§æ¨™
          if (rawData.features) {
            rawData.features.forEach((feature) => {
              if (feature.geometry && feature.geometry.type === 'LineString') {
                // ä¿å­˜åŸå§‹åº§æ¨™åˆ° properties
                const originalCoords = JSON.parse(
                  JSON.stringify(feature.geometry.coordinates)
                );
                if (!feature.properties) {
                  feature.properties = {};
                }
                feature.properties.originalCoordinates = originalCoords;

                // å»¶ä¼¸ç·šæ®µ
                feature.geometry.coordinates = extendLineString(
                  feature.geometry.coordinates
                );
              }
            });
          }

          runwayData.value = rawData;

          console.log('[MapTab] è·‘é“ç·šè·¯æ•¸æ“šè¼‰å…¥æˆåŠŸ');
          console.log('  - ç·šè·¯æ•¸é‡:', runwayData.value.features?.length || 0);
          console.log('  - å·²å°‡æ¯æ¢ç·šå»¶ä¼¸ 5 å€é•·åº¦');

          return true;
        } catch (error) {
          console.error('[MapTab] è·‘é“ç·šè·¯æ•¸æ“šè¼‰å…¥å¤±æ•—:', error);
          return false;
        }
      };

      /**
       * ğŸ› ï¸ å‰µå»ºå·¥å…·æç¤ºå…ƒç´ 
       */
      const createTooltip = () => {
        if (!mapContainer.value) return;

        // ç§»é™¤å·²å­˜åœ¨çš„å·¥å…·æç¤º
        const existingTooltip = mapContainer.value.querySelector('.map-tooltip');
        if (existingTooltip) {
          existingTooltip.remove();
        }

        // å‰µå»ºæ–°çš„å·¥å…·æç¤ºå…ƒç´ 
        tooltip = document.createElement('div');
        tooltip.className = 'map-tooltip';
        tooltip.style.position = 'absolute';
        tooltip.style.pointerEvents = 'none';
        tooltip.style.opacity = '0';
        tooltip.style.padding = '4px 8px';

        mapContainer.value.appendChild(tooltip);
        console.log('[MapTab] å·¥å…·æç¤ºå…ƒç´ å‰µå»ºæˆåŠŸ');
      };

      /**
       * ğŸ“ è‡ªå‹•èª¿æ•´åœ°åœ–è¦–åœ–ä»¥é¡¯ç¤ºæ‰€æœ‰ç‰©ä»¶
       */
      const fitMapToFeatures = () => {
        if (!projection || !runwayData.value || !svg) {
          console.warn('[MapTab] ç„¡æ³•èª¿æ•´è¦–åœ–ï¼šç¼ºå°‘å¿…è¦çš„çµ„ä»¶');
          return;
        }

        try {
          const width = +svg.attr('width');
          const height = +svg.attr('height');

          // ä½¿ç”¨ D3 çš„ fitExtent è‡ªå‹•èª¿æ•´æŠ•å½±
          // æ·»åŠ  10% çš„é‚Šè·
          const padding = Math.min(width, height) * 0.1;

          // ä½¿ç”¨ fitExtent æ–¹æ³•è‡ªå‹•èª¿æ•´æŠ•å½±ä»¥é©æ‡‰æ‰€æœ‰ç‰¹å¾µ
          projection.fitExtent(
            [
              [padding, padding],
              [width - padding, height - padding],
            ],
            runwayData.value
          );

          // æ›´æ–°è·¯å¾‘ç”Ÿæˆå™¨
          path = d3.geoPath().projection(projection);

          // é‡æ–°ç¹ªè£½å»¶ä¼¸çš„è·¯å¾‘
          g.selectAll('.runway-extended').attr('d', path);

          // é‡æ–°ç¹ªè£½åŸå§‹é•·åº¦çš„è·¯å¾‘ï¼ˆé»ƒè‰²ï¼‰
          g.selectAll('.runway-original').attr('d', (d) => {
            const originalFeature = {
              type: 'Feature',
              geometry: {
                type: 'LineString',
                coordinates: d.properties.originalCoordinates,
              },
            };
            return path(originalFeature);
          });

          console.log('[MapTab] åœ°åœ–è¦–åœ–å·²èª¿æ•´ä»¥é¡¯ç¤ºæ‰€æœ‰ç‰©ä»¶');
          console.log('  - è¦–åœ–å°ºå¯¸:', width, 'x', height);
          console.log('  - é‚Šè·:', padding);
        } catch (error) {
          console.error('[MapTab] èª¿æ•´è¦–åœ–å¤±æ•—:', error);
        }
      };

      /**
       * ğŸ—ºï¸ ç¹ªè£½è·‘é“ç·šè·¯
       */
      const drawRunway = () => {
        if (!g || !runwayData.value) {
          console.error(
            '[MapTab] ç„¡æ³•ç¹ªè£½è·‘é“ç·šè·¯: g=',
            !!g,
            'runwayData=',
            !!runwayData.value
          );
          return;
        }

        try {
          console.log('[MapTab] é–‹å§‹ç¹ªè£½è·‘é“ç·šè·¯ GeoJSON');

          // å…ˆç¹ªè£½å»¶ä¼¸å¾Œçš„è·‘é“ç·šè·¯ï¼ˆç°è‰²ï¼Œåº•å±¤ï¼‰
          g.selectAll('.runway-extended')
            .data(runwayData.value.features)
            .enter()
            .append('path')
            .attr('d', path)
            .attr('class', 'runway-extended')
            .attr('fill', 'none')
            .attr('stroke', '#333333')
            .attr('stroke-width', 2)
            .attr('stroke-opacity', 0.8);

          // å†ç¹ªè£½åŸå§‹é•·åº¦çš„è·‘é“ç·šè·¯ï¼ˆé»ƒè‰²ï¼Œæœ€ä¸Šå±¤ï¼‰
          g.selectAll('.runway-original')
            .data(
              runwayData.value.features.filter(
                (f) => f.properties?.originalCoordinates
              )
            )
            .enter()
            .append('path')
            .attr('d', (d) => {
              // ä½¿ç”¨åŸå§‹åº§æ¨™å‰µå»ºè‡¨æ™‚çš„ GeoJSON ç‰¹å¾µ
              const originalFeature = {
                type: 'Feature',
                geometry: {
                  type: 'LineString',
                  coordinates: d.properties.originalCoordinates,
                },
              };
              return path(originalFeature);
            })
            .attr('class', 'runway-original')
            .attr('fill', 'none')
            .attr('stroke', '#FFD700')
            .attr('stroke-width', 3)
            .attr('stroke-opacity', 1.0)
            .on('mouseover', function (event, d) {
              // é¡¯ç¤ºå·¥å…·æç¤º
              const properties = d.properties || {};
              const id = properties.id || 'N/A';

              const tooltipContent = `
                <div style="font-weight: bold;">è·‘é“ç·šè·¯ï¼ˆåŸå§‹é•·åº¦ï¼‰</div>
                <div>ID: ${id}</div>
              `;

              tooltip.innerHTML = tooltipContent;
              tooltip.style.opacity = '1';
            })
            .on('mousemove', function (event) {
              // æ›´æ–°å·¥å…·æç¤ºä½ç½®
              tooltip.style.left = event.pageX + 10 + 'px';
              tooltip.style.top = event.pageY - 10 + 'px';
            })
            .on('mouseout', function () {
              // éš±è—å·¥å…·æç¤º
              tooltip.style.opacity = '0';
            });

          console.log('[MapTab] è·‘é“ç·šè·¯ GeoJSON ç¹ªè£½å®Œæˆ');

          // ç¹ªè£½å®Œæˆå¾Œè‡ªå‹•èª¿æ•´è¦–åœ–
          setTimeout(() => {
            fitMapToFeatures();
          }, 100);
        } catch (error) {
          console.error('[MapTab] è·‘é“ç·šè·¯ GeoJSON ç¹ªè£½å¤±æ•—:', error);
        }
      };

      /**
       * ğŸ›ï¸ åˆ‡æ›é¡¯ç¤ºæ¨¡å¼
       * @param {string} mode - 'map' æˆ– 'grid'
       */
      const toggleDisplayMode = async () => {
        // åƒ…ä¿ç•™åœ°åœ–æ¨¡å¼
        displayMode.value = 'map';
        console.log('[MapTab] åˆ‡æ›é¡¯ç¤ºæ¨¡å¼: map (grid å·²åœç”¨)');

        if (displayMode.value === 'map') {
          // åœ°åœ–æ¨¡å¼ï¼šéœ€è¦åœ°åœ–æŠ•å½±ï¼Œè¼‰å…¥è·‘é“ç·šè·¯
          if (!runwayData.value) {
            await loadRunwayData();
          }
          // æ¸…é™¤èˆŠçš„ SVGï¼ˆå¦‚æœå¾å…¶ä»–æ¨¡å¼åˆ‡æ›éä¾†ï¼‰
          if (svg && !projection) {
            svg.remove();
            svg = null;
          }

          if (!projection || !path) {
            // å¦‚æœé‚„æ²’æœ‰å‰µå»ºåœ°åœ–ï¼Œå…ˆå‰µå»º
            const rect = mapContainer.value.getBoundingClientRect();
            if (rect.width > 0 && rect.height > 0) {
              const width = rect.width;
              const height = rect.height;

              // æ¸…é™¤èˆŠçš„ SVG
              if (svg) {
                svg.remove();
              }

              // å‰µå»º SVG å’Œåœ°åœ–æŠ•å½±
              svg = d3
                .select(mapContainer.value)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .style('background', '#ffffff');

              projection = d3
                .geoMercator()
                .center([121, 23.5])
                .scale(12000)
                .translate([width / 2, height / 2]);

              path = d3.geoPath().projection(projection);
              g = svg.append('g');

              zoom = d3
                .zoom()
                .scaleExtent([0.5, 50])
                .on('zoom', (event) => {
                  g.attr('transform', event.transform);
                });

              svg.call(zoom);

              // é‡ç½®ç¸®æ”¾ç‹€æ…‹ï¼Œç¢ºä¿åˆ‡æ›æ¨¡å¼æ™‚ä¸æœƒå—åˆ°ä¹‹å‰æ¨¡å¼çš„å½±éŸ¿
              svg.call(zoom.transform, d3.zoomIdentity);

              createTooltip();
              isMapReady.value = true;
            }
          } else {
            // å¦‚æœå·²ç¶“å‰µå»ºäº†åœ°åœ–ï¼Œé‡ç½®ç¸®æ”¾ç‹€æ…‹
            if (svg && zoom) {
              svg.call(zoom.transform, d3.zoomIdentity);
            }
          }
          // ç¹ªè£½è·‘é“ç·šè·¯
          drawRunway();
        }
      };

      /**
       * ğŸ—ï¸ å‰µå»ºåœ°åœ–å¯¦ä¾‹
       * åˆå§‹åŒ– D3.js åœ°åœ–ä¸¦è¨­å®šåŸºæœ¬é…ç½®
       */
      const createMap = () => {
        if (!mapContainer.value) return false;

        const rect = mapContainer.value.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) {
          console.warn('[MapTab] å®¹å™¨å°ºå¯¸ç‚ºé›¶ï¼Œå»¶é²åˆå§‹åŒ–');
          return false;
        }

        try {
          const width = rect.width;
          const height = rect.height;

          // å°ç£ä¸­å¿ƒä½ç½®ï¼šç·¯åº¦ 23.5Â°, ç¶“åº¦ 121Â°

          // å‰µå»º SVG å…ƒç´ 
          svg = d3
            .select(mapContainer.value)
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .style('background', '#ffffff'); // ç´”ç™½è‰²èƒŒæ™¯

          // å‰µå»ºæŠ•å½± - éº¥å¡æ‰˜æŠ•å½±ï¼Œèšç„¦åœ¨å°ç£
          projection = d3
            .geoMercator()
            .center([121, 23.5]) // ä¸­å¿ƒé»åœ¨å°ç£
            .scale(12000) // æ›´å¤§çš„ç¸®æ”¾æ¯”ä¾‹ï¼Œæ›´èšç„¦åœ¨å°ç£
            .translate([width / 2, height / 2]);

          // å‰µå»ºè·¯å¾‘ç”Ÿæˆå™¨
          path = d3.geoPath().projection(projection);

          // å‰µå»ºå®¹å™¨çµ„
          g = svg.append('g');

          // è¨­ç½®ç¸®æ”¾è¡Œç‚º
          zoom = d3
            .zoom()
            .scaleExtent([0.5, 50]) // å…è¨±ç¸®æ”¾ 0.5x åˆ° 50x
            .on('zoom', (event) => {
              g.attr('transform', event.transform);
            });

          svg.call(zoom);

          // é‡ç½®ç¸®æ”¾ç‹€æ…‹ï¼Œç¢ºä¿åˆ‡æ›æ¨¡å¼æ™‚ä¸æœƒå—åˆ°ä¹‹å‰æ¨¡å¼çš„å½±éŸ¿
          svg.call(zoom.transform, d3.zoomIdentity);

          // å‰µå»ºå·¥å…·æç¤ºå…ƒç´ 
          createTooltip();

          isMapReady.value = true;

          // å°‡åœ°åœ–å¯¦ä¾‹å‚³éçµ¦çˆ¶çµ„ä»¶
          emit('map-ready', { svg, projection, path });

          console.log('[MapTab] D3.js åœ°åœ–å‰µå»ºæˆåŠŸ');
          return true;
        } catch (error) {
          console.error('[MapTab] D3.js åœ°åœ–å‰µå»ºå¤±æ•—:', error);
          return false;
        }
      };

      /**
       * ğŸš€ åˆå§‹åŒ–åœ°åœ–
       * æ ¹æ“šåˆå§‹é¡¯ç¤ºæ¨¡å¼å‰µå»ºå°æ‡‰çš„è¦–åœ–
       */
      const initMap = async () => {
        let attempts = 0;
        const maxAttempts = 20;

        // æ ¹æ“šé¡¯ç¤ºæ¨¡å¼è¼‰å…¥ä¸åŒçš„æ•¸æ“š
        if (displayMode.value === 'map') {
          // åœ°åœ–æ¨¡å¼ï¼šè¼‰å…¥è·‘é“ç·šè·¯æ•¸æ“š
          console.log('[MapTab] é–‹å§‹è¼‰å…¥åœ°åœ–æ¨¡å¼æ•¸æ“š...');
          const runwayLoaded = await loadRunwayData();

          if (!runwayLoaded) {
            console.error('[MapTab] ç„¡æ³•è¼‰å…¥è·‘é“ç·šè·¯æ•¸æ“š');
            return;
          }

          console.log('[MapTab] æ•¸æ“šè¼‰å…¥å®Œæˆï¼Œé–‹å§‹å‰µå»ºåœ°åœ–');

          const tryCreateMap = async () => {
            if (attempts >= maxAttempts) {
              console.error('[MapTab] åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼Œå·²é”åˆ°æœ€å¤§å˜—è©¦æ¬¡æ•¸');
              return;
            }

            attempts++;
            console.log(`[MapTab] å˜—è©¦å‰µå»ºåœ°åœ– (${attempts}/${maxAttempts})`);

            if (createMap()) {
              console.log('[MapTab] åœ°åœ–å‰µå»ºæˆåŠŸï¼Œé–‹å§‹ç¹ªè£½åœ–å±¤');
              // ç¹ªè£½è·‘é“ç·šè·¯
              drawRunway();
            } else {
              console.log('[MapTab] åœ°åœ–å‰µå»ºå¤±æ•—ï¼Œ100ms å¾Œé‡è©¦');
              setTimeout(tryCreateMap, 100);
            }
          };

          tryCreateMap();
        }
      };

      // ğŸ§¹ ç”Ÿå‘½é€±æœŸï¼šçµ„ä»¶æ›è¼‰
      onMounted(() => {
        nextTick(() => {
          initMap();
        });
      });

      // ğŸ§¹ ç”Ÿå‘½é€±æœŸï¼šçµ„ä»¶å¸è¼‰
      onUnmounted(() => {
        if (svg) {
          svg.remove();
          svg = null;
        }

        // æ¸…ç†å·¥å…·æç¤º
        if (tooltip) {
          tooltip.remove();
          tooltip = null;
        }

        projection = null;
        path = null;
        zoom = null;
        g = null;
        isMapReady.value = false;
      });

      // ğŸ“¤ è¿”å›çµ„ä»¶å…¬é–‹çš„å±¬æ€§å’Œæ–¹æ³•
      return {
        mapContainer,
        mapContainerId,
        displayMode,
        toggleDisplayMode,
      };
    },
  };
</script>

<template>
  <!-- ğŸ—ºï¸ åœ°åœ–ä¸»å®¹å™¨ -->
  <div id="map-container" class="h-100 w-100 position-relative bg-transparent z-0">
    <!-- ğŸ—ºï¸ Leaflet åœ°åœ–å®¹å™¨ -->
    <div :id="mapContainerId" ref="mapContainer" class="h-100 w-100"></div>
  </div>
</template>

<style scoped>
  @import '../assets/css/common.css';

  #map-container {
    overflow: hidden;
    background: #ffffff; /* ç´”ç™½è‰²èƒŒæ™¯ */
  }

  :deep(.leaflet-container) {
    background: #ffffff; /* ç´”ç™½è‰²èƒŒæ™¯ */
  }

  :deep(.leaflet-popup-content-wrapper) {
    background: rgba(0, 43, 127, 0.95); /* è«¾é­¯æ·±è—è‰²åŠé€æ˜ */
    color: #ffc61e; /* é‡‘é»ƒè‰²æ–‡å­— */
    border: 2px solid #ffc61e; /* é‡‘é»ƒè‰²é‚Šæ¡† */
  }

  :deep(.leaflet-popup-tip) {
    background: rgba(0, 43, 127, 0.95); /* è«¾é­¯æ·±è—è‰²åŠé€æ˜ */
  }

  :deep(.leaflet-tooltip) {
    background-color: rgba(0, 43, 127, 0.95) !important; /* è«¾é­¯æ·±è—è‰² */
    color: #ffc61e !important; /* é‡‘é»ƒè‰²æ–‡å­— */
    border: 1px solid #ffc61e !important; /* é‡‘é»ƒè‰²é‚Šæ¡† */
    font-size: 14px;
    padding: 8px 12px;
    border-radius: 4px;
    line-height: 1.4;
  }

  :deep(.map-tooltip) {
    background-color: rgba(0, 0, 0, 0.9); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
    color: #fff; /* ç™½è‰²æ–‡å­— */
    border: 2px solid #fff; /* ç™½è‰²é‚Šæ¡† */
    border-radius: 8px; /* åœ“è§’ */
    padding: 12px; /* å…§é‚Šè· */
    font-size: 14px; /* å­—é«”å¤§å° */
    font-family: 'Arial', sans-serif; /* å­—é«” */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* é™°å½± */
    z-index: 1000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    max-width: 250px; /* æœ€å¤§å¯¬åº¦ */
    line-height: 1.4; /* è¡Œé«˜ */
  }
</style>
